// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ETUDIANT
  PROPRIETAIRE
  ADMIN
}

model User {
  id        Int      @id @default(autoincrement())
  nom       String
  prenom    String?
  email     String   @unique
  password  String
  avatar    String?  // Pour la photo de profil (le rond avec l'initiale)
  role      Role     @default(ETUDIANT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  offres      Offre[]       @relation("ProprietaireOffres") // Les offres qu'il a postées (si proprio)
  avisDonnes  Avis[]        @relation("AvisAuteur")         // Les avis qu'il a écrits
  documents   Document[]                                    // Ses pièces justificatives (Profile.vue)
  messagesEnvoi Message[]   @relation("Expediteur")
  messagesRecu  Message[]   @relation("Destinataire")
}

// --------------------------------------
// 2. GESTION DOCUMENTS (Profile.vue)
// --------------------------------------

enum DocStatus {
  EN_ATTENTE
  VALIDE
  REFUSE
}

model Document {
  id        Int       @id @default(autoincrement())
  nom       String    // Ex: "Carte d'identité"
  url       String    // Lien vers le fichier PDF/JPG
  type      String    // "identite", "garant", etc.
  status    DocStatus @default(EN_ATTENTE)
  
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 3. GESTION DES OFFRES (Immo)
// --------------------------------------

model Offre {
  id          Int      @id @default(autoincrement())
  titre       String
  description String   @db.Text
  prix        Int
  charges     Int?     @default(0) // Nouveau: Charges comprises ou non
  caution     Int?
  surface     Int?     // Utile pour l'immo
  lieu        String
  coloc       Int      @default(0) // Nombre de places dispos
  
  // Equipements (Tags) - On garde JSON pour la simplicité, c'est très bien ici
  tags        Json?    // ['Fibre', 'Lave-linge', 'Proche Gare']

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  proprietaireId Int
  proprietaire   User          @relation("ProprietaireOffres", fields: [proprietaireId], references: [id])
  
  images         OffreImage[]  // Galerie d'images ([id].vue)
  avis           Avis[]        // Liste des avis liés à cette offre
}

// Table dédiée pour avoir plusieurs images par offre
model OffreImage {
  id       Int    @id @default(autoincrement())
  url      String
  offreId  Int
  offre    Offre  @relation(fields: [offreId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 4. GESTION DES AVIS (Avis.vue)
// --------------------------------------

model Avis {
  id          Int      @id @default(autoincrement())
  note        Int      // 1 à 5
  commentaire String   @db.Text
  createdAt   DateTime @default(now())

  // Qui a écrit l'avis ?
  auteurId    Int
  auteur      User     @relation("AvisAuteur", fields: [auteurId], references: [id])

  // Sur quelle offre ?
  offreId     Int
  offre       Offre    @relation(fields: [offreId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 5. MESSAGERIE (Contact.vue)
// --------------------------------------

model Message {
  id          Int      @id @default(autoincrement())
  contenu     String   @db.Text
  type        String   @default("texte")
  createdAt   DateTime @default(now())
  lu          Boolean  @default(false)

  expediteurId Int
  expediteur   User    @relation("Expediteur", fields: [expediteurId], references: [id])

  destinataireId Int
  destinataire   User    @relation("Destinataire", fields: [destinataireId], references: [id])
}
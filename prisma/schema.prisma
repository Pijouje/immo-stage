// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ETUDIANT
  PROPRIETAIRE
  ADMIN
}

model User {
  id        Int      @id @default(autoincrement())
  nom       String
  prenom    String?
  email     String   @unique
  password  String
  avatar    String?
  role      Role     @default(ETUDIANT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  offres                   Offre[]            @relation("ProprietaireOffres")
  avis                     Avis[]             @relation("AvisAuteur")
  documents                Document[]
  messagesEnvoi            Message[]          @relation("Expediteur")
  messagesRecu             Message[]          @relation("Destinataire")
  reviewPermissions        ReviewPermission[] @relation("PermissionUser")
  reviewPermissionsGranted ReviewPermission[] @relation("GrantedPermissions")
}

// --------------------------------------
// 2. GESTION DOCUMENTS
// --------------------------------------

enum DocStatus {
  EN_ATTENTE
  VALIDE
  REFUSE
}

model Document {
  id     Int       @id @default(autoincrement())
  nom    String
  url    String
  type   String
  status DocStatus @default(EN_ATTENTE)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 3. GESTION DES OFFRES
// --------------------------------------

model Offre {
  id          Int      @id @default(autoincrement())
  titre       String
  description String   @db.Text
  prix        Int
  charges     Int?     @default(0)
  caution     Int?
  surface     Int?
  lieu        String
  coloc               Int      @default(0)
  chambresDisponibles Int?
  tags                Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  proprietaireId Int
  proprietaire   User @relation("ProprietaireOffres", fields: [proprietaireId], references: [id])

  images            OffreImage[]
  avis              Avis[]
  reviewPermissions ReviewPermission[]
}

model OffreImage {
  id      Int    @id @default(autoincrement())
  url     String
  offreId Int
  offre   Offre  @relation(fields: [offreId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 4. GESTION DES AVIS
// --------------------------------------

model ReviewPermission {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  userId Int
  user   User @relation("PermissionUser", fields: [userId], references: [id], onDelete: Cascade)

  offreId Int
  offre   Offre @relation(fields: [offreId], references: [id], onDelete: Cascade)

  grantedBy     Int
  grantedByUser User @relation("GrantedPermissions", fields: [grantedBy], references: [id])

  @@unique([userId, offreId])
}

model Avis {
  id          Int      @id @default(autoincrement())
  note        Int
  commentaire String   @db.Text
  createdAt   DateTime @default(now())

  auteurId Int
  auteur   User  @relation("AvisAuteur", fields: [auteurId], references: [id], onDelete: Cascade)

  offreId Int
  offre   Offre @relation(fields: [offreId], references: [id], onDelete: Cascade)

  @@unique([auteurId, offreId])
}

// --------------------------------------
// 5. MESSAGERIE
// --------------------------------------

model Message {
  id          Int      @id @default(autoincrement())
  contenu     String   @db.Text
  nom         String?
  type        String   @default("texte")
  createdAt   DateTime @default(now())
  lu          Boolean  @default(false)

  expediteurId Int
  expediteur   User @relation("Expediteur", fields: [expediteurId], references: [id])

  destinataireId Int
  destinataire   User @relation("Destinataire", fields: [destinataireId], references: [id])
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}
